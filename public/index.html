<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>è–¬å‰¤ãƒã‚§ãƒƒã‚¯ã‚¢ãƒ—ãƒª</title>

  <style>
    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      background: #f4f7fb;
      margin: 0;
      padding: 40px;
    }

    h2 {
      color: #1e3a8a;
      margin-bottom: 20px;
    }

    button {
      background: #1e3a8a;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background: #16307a;
    }

    textarea {
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 10px;
      font-size: 14px;
    }

    .card {
      border: 1px solid #dbeafe;
      background: white;
      padding: 18px;
      margin: 15px 0;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      font-size: 15px;
      line-height: 1.7;
    }

    .warning-title {
      color: #b91c1c;
      font-weight: bold;
      margin-top: 30px;
    }

    .safe {
      color: #15803d;
      font-weight: bold;
      margin-top: 20px;
    }

    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }

    .preview-img {
      width: 110px;
      margin: 8px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      object-fit: cover;
    }

    .preview-wrapper {
      display: flex;
      flex-wrap: wrap;
    }

  </style>
</head>
<body>
  <div class="container">
  <h2>è–¬å‰¤ãƒã‚§ãƒƒã‚¯ã‚¢ãƒ—ãƒª</h2>

ã€€<!-- ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ -->
ã€€<button onclick="openCamera()">ğŸ“¸ ã‚«ãƒ¡ãƒ©ã§æ’®å½±</button>

ã€€<!-- ç”»åƒé¸æŠãƒœã‚¿ãƒ³ï¼ˆPCç”¨ï¼‰ -->
ã€€<button onclick="document.getElementById('imageInput').click()">
ã€€ğŸ–¼ ç”»åƒã‚’é¸æŠ
ã€€</button>

ã€€<!-- å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ï¼ˆéè¡¨ç¤ºï¼‰ -->
ã€€<input
    type="file"
    id="imageInput"
    accept="image/*"
    capture="environment"
    multiple
    style="display:none;"
    onchange="handleFileSelect(event)"
  />



ã€€<br><br>

ã€€<!-- è§£æãƒœã‚¿ãƒ³ -->
ã€€<button onclick="uploadImage()">è§£æã™ã‚‹</button>

  <div id="previewContainer" style="margin-top:20px;"></div>


  <div id="ocrSection" style="display:none;">
    <h3>OCRçµæœï¼ˆä¿®æ­£ã§ãã¾ã™ï¼‰</h3>
    <textarea id="ocrEditBox" rows="6" style="width:100%;"></textarea>
    <br><br>
    <button onclick="recheckDrugs()">ã“ã®å†…å®¹ã§å†åˆ¤å®š</button>
  </div>

  <div id="result"></div>

  <script>

  let selectedFiles = [];

  function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    selectedFiles.push(...files);
    renderPreview();
  }

  function renderPreview() {
    const previewContainer = document.getElementById("previewContainer");
    previewContainer.innerHTML = "";
    previewContainer.className = "preview-wrapper";

    selectedFiles.forEach((file, index) => {
      const reader = new FileReader();

      reader.onload = function(e) {
        const wrapper = document.createElement("div");
        wrapper.style.position = "relative";

        const img = document.createElement("img");
        img.src = e.target.result;
        img.className = "preview-img";

        const delBtn = document.createElement("button");
        delBtn.innerText = "Ã—";
        delBtn.style.position = "absolute";
        delBtn.style.top = "6px";
        delBtn.style.right = "6px";
        delBtn.style.background = "#b02a37";
        delBtn.style.color = "white";
        delBtn.style.border = "none";
        delBtn.style.borderRadius = "6px";
        delBtn.style.padding = "4px 8px";
	delBtn.style.fontSize = "20px";
	delBtn.style.cursor = "pointer";
	delBtn.style.opacity = "0.9";
	delBtn.style.transition = "0.2s ease";

	delBtn.onmouseenter = () => {
 	  delBtn.style.background = "#c82333";
	};

	delBtn.onmouseleave = () => {
  	  delBtn.style.background = "#b02a37";
	};

        delBtn.onclick = () => removeImage(index);

        wrapper.appendChild(img);
        wrapper.appendChild(delBtn);
        previewContainer.appendChild(wrapper);
      };

      reader.readAsDataURL(file);
    });
  }

  function removeImage(index) {
    selectedFiles.splice(index, 1);
    renderPreview();
  }

ã€€function openCamera() {
  ã€€const input = document.getElementById("imageInput");

ã€€  if (!input) {
   ã€€ alert("imageInputãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
   ã€€ return;
 ã€€ }

 ã€€ input.setAttribute("capture", "environment");
 ã€€ input.click();
ã€€}

  async function uploadImage() {

    if (!selectedFiles.length) {
      alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    const buttons = document.querySelectorAll("button");
    buttons.forEach(btn => btn.disabled = true);

    document.getElementById("result").innerHTML = "<div>è§£æä¸­ã§ã™â€¦</div>";

    const requests = selectedFiles.map(file => {
      const formData = new FormData();
      formData.append("image", file);

      return fetch("/ocr", {
        method: "POST",
        body: formData
      }).then(res => res.json());
    });

    let responses;

    try {
      responses = await Promise.all(requests);
    } catch (err) {
      console.error("OCRã‚¨ãƒ©ãƒ¼:", err);
      document.getElementById("result").innerHTML =
        "OCRå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";

      buttons.forEach(btn => btn.disabled = false);
      return;
    }

    buttons.forEach(btn => btn.disabled = false);

    let allExtracted = [];
    let allMatched = [];

    responses.forEach(data => {
      if (data.extractedDrugs)
        allExtracted.push(...data.extractedDrugs);

      if (data.matchedDrugs)
        allMatched.push(...data.matchedDrugs);
    });

    const uniqueExtracted = [...new Set(allExtracted)];

    document.getElementById("ocrSection").style.display = "block";
    document.getElementById("ocrEditBox").value =
      uniqueExtracted.join("\n");

    const uniqueMatched = [];
    const seen = new Set();

    for (const drug of allMatched) {
      const key = drug.å•†å“å + drug.ä¼‘è–¬æœŸé–“;
      if (!seen.has(key)) {
        seen.add(key);
        uniqueMatched.push(drug);
      }
    }

    displayResults(uniqueMatched);
  }

  function recheckDrugs() {
    const text = document.getElementById("ocrEditBox").value;

    if (!text.trim()) {
      alert("ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™");
      return;
    }

    // 1è¡Œãšã¤é…åˆ—ã«
    const drugs = text
      .split("\n")
      .map(d => d.trim())
      .filter(d => d !== "");

    // ã‚µãƒ¼ãƒãƒ¼ã¸å†åˆ¤å®šãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    fetch("/recheck", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ drugs })
    })
       .then(res => res.json())
       .then(data => {
        displayResults(data.matchedDrugs || []);
      })
       .catch(err => {
        console.error("å†åˆ¤å®šã‚¨ãƒ©ãƒ¼:", err);
        document.getElementById("result").innerHTML =
          "å†åˆ¤å®šã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
      });
  }

  function displayResults(uniqueMatched) {
  
    if (!uniqueMatched || uniqueMatched.length === 0) {
      document.getElementById("result").innerHTML =
        "<div class='safe'>âœ” ä¼‘è–¬ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹è–¬å‰¤ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
      return;
    }

    let html = "<div class='warning-title'>âš  ä¼‘è–¬æ¨å¥¨è–¬å‰¤</div>";

    uniqueMatched.forEach(drug => {
      html += `
        <div class="card">
          ${drug.å•†å“å}ã¯${drug.ä¼‘è–¬æœŸé–“}ã‚ˆã‚Šä¼‘è–¬ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
        </div>
      `;
    });

    document.getElementById("result").innerHTML = html;
  }
  </script>

  </div>
</body>
</html>
